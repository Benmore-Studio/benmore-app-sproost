{% extends "admin/base.html" %}

{% block extrahead %}
    {{ block.super }}
    <!-- Tailwind CSS via CDN (for demo) -->
     <!-- Toastify CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

    <!-- Toastify JS -->
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.2.7/dist/tailwind.min.css" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Rubik:ital,wght@0,300..900;1,300..900&display=swap" rel="stylesheet">
{% endblock extrahead %}

{% block userlinks %}
    {{ block.super }}

    <!-- Modal (hidden by default) -->
  <div id="create-chatModal" class="fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-50 hidden" style="z-index: 100;">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md fixed z-index-50">
      <!-- Modal Header -->
      <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-xl font-semibold">Create Group Chat</h3>
      </div>
      <!-- Modal Body -->
      <div class="px-6 py-4">
        <!-- Room Name Input -->
        <div class="mb-4">
          <label for="roomName" class="block text-gray-700 text-sm font-bold mb-2">Room Name</label>
          <input id="roomName" type="text" placeholder="Enter room name"  class="w-full rounded-3xl h-full focus:outline-none bg-transparent border-none focus:border-gray-500">
        </div>
        <!-- User Search Input -->
        <div class="mb-4">
          <label for="userSearch" class="block text-gray-700 text-sm font-bold mb-2">Add Users</label>
          <input id="userSearch" type="text" placeholder="Search for users..." class="w-full rounded-3xl h-full focus:outline-none bg-transparent border-none focus:border-gray-500" onkeyup="liveSearchUsers()">
        </div>
        <!-- Search Results -->
        <div id="searchResults" class="mb-4 max-h-40 overflow-y-scroll">
          <!-- Live search results will appear here -->
        </div>
        <!-- No user found message -->
        <div id="noUserFound" class="hidden text-red-500 text-sm">
          Oops, user not found.
          <button id="sendInviteBtn" class="underline text-blue-500 ml-2">Send Invite</button>
        </div>
        <!-- Selected Users -->
        <div id="selectedUsers" class="mb-4 max-h-32 overflow-y-scroll">
          <h4 class="text-gray-700 font-bold mb-2">Selected Users:</h4>
          <!-- Selected users will be appended here -->
        </div>
      </div>
      <!-- Modal Footer -->
      <div class="px-6 py-4 border-t border-gray-200 flex justify-end">
        <button id="closeModalBtn"  class="inline-flex items-center w-[70%] md:w-[50%] justify-center p-3 rounded-3xl bg-red-600 text-white border border-neutral-150 shadow-sm font-semibold">Cancel</button>
        <button id="createRoomBtn"  class="inline-flex items-center w-[70%] md:w-[50%] justify-center p-3 rounded-3xl bg-[#417690] text-white border border-neutral-150 shadow-sm font-semibold">Create Room</button>
      </div>
    </div>
  </div>

  <!-- only add user modal -->
  <div id="only-add-user-modal" class="fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-50" style="z-index: 100; display: none;">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md fixed z-index-50">
      <!-- Modal Header -->
      <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-xl font-semibold">Add users to Chat</h3>
      </div>
      <!-- Modal Body -->
      <div class="px-6 py-4">
        <!-- User Search Input -->
        <div class="mb-4">
          <label for="admin-userSearch" class="block text-gray-700 text-sm font-bold mb-2">Add Users</label>
          <input id="admin-userSearch" type="text" placeholder="Search for users..." class="w-full rounded-3xl h-full focus:outline-none bg-transparent border-none focus:border-gray-500" onkeyup="adminLiveSearchUsers()">
        </div>
        <!-- Search Results -->
        <div id="admin-searchResults" class="mb-4 max-h-40 overflow-y-scroll">
          <!-- Live search results will appear here -->
        </div>
        <!-- No user found message -->
        <div id="admin-noUserFound" class="hidden text-red-500 text-sm">
          Oops, user not found.
          <button id="admin-sendInviteBtn" class="underline text-blue-500 ml-2">Send Invite</button>
        </div>
        <!-- Selected Users -->
        <div id="admin-selectedUsers" class="mb-4 max-h-32 overflow-y-scroll">
          <h4 class="text-gray-700 font-bold mb-2">Selected Users:</h4>
          <!-- Selected users will be appended here -->
        </div>
      </div>
      <!-- Modal Footer -->
      <div class="px-6 py-4 border-t border-gray-200 flex justify-end">
        <button id="admin-closeModalBtn"  class="inline-flex items-center w-[70%] md:w-[50%] justify-center p-3 rounded-3xl bg-red-600 text-white border border-neutral-150 shadow-sm font-semibold">Cancel</button>
        <button id="admin-add-users"  class="inline-flex items-center w-[70%] md:w-[50%] justify-center p-3 rounded-3xl bg-[#417690] text-white border border-neutral-150 shadow-sm font-semibold">Add Users</button>
      </div>
    </div>
  </div>

  <!-- leave room yes or no modal-->
  <div id="leave-room-yes-or-no-modal" class="fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-50" style="z-index: 100; display: none;">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md fixed z-index-50">
      <!-- Modal Header -->
      <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-xl font-semibold">Are you sure you want to leave room?</h3>
      </div>
      <!-- Modal Body -->
      <div class="px-6 py-4 border-t border-gray-200 flex justify-end">
        <button id="leave-room-closeModalBtn"  class="inline-flex items-center w-[70%] md:w-[50%] justify-center p-3 rounded-3xl bg-red-600 text-white border border-neutral-150 shadow-sm font-semibold">Cancel</button>
        <button id="leave-room-confirm"  class="inline-flex items-center w-[70%] md:w-[50%] justify-center p-3 rounded-3xl bg-[#417690] text-white border border-neutral-150 shadow-sm font-semibold">Leave</button>
      </div>
    </div>
  </div>

  <!-- Delete room yes or no modal-->
  <div id="delete-room-yes-or-no-modal" class="fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-50" style="z-index: 100; display: none;">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md fixed z-index-50">
      <!-- Modal Header -->
      <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-xl font-semibold">Are you sure you want to delete room?</h3>
      </div>
      <!-- Modal Body -->
      <div class="px-6 py-4 border-t border-gray-200 flex justify-end">
        <button id="delete-room-closeModalBtn"  class="inline-flex items-center w-[70%] md:w-[50%] justify-center p-3 rounded-3xl bg-red-600 text-white border border-neutral-150 shadow-sm font-semibold">Cancel</button>
        <button id="delete-room-confirm"  class="inline-flex items-center w-[70%] md:w-[50%] justify-center p-3 rounded-3xl bg-[#417690] text-white border border-neutral-150 shadow-sm font-semibold">Delete</button>
      </div>
    </div>
  </div>

  <!-- remove user yes or no modal-->
  <div id="remove-user-yes-or-no-modal" class="fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-50" style="z-index: 100; display: none;">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md fixed z-index-50">
      <!-- Modal Header -->
      <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-xl font-semibold">Are you sure you want to remove this user?</h3>
      </div>
      <!-- Modal Body -->
      <div class="px-6 py-4 border-t border-gray-200 flex justify-end">
        <button id="remove-user-closeModalBtn"  class="inline-flex items-center w-[70%] md:w-[50%] justify-center p-3 rounded-3xl bg-red-600 text-white border border-neutral-150 shadow-sm font-semibold">Cancel</button>
        <button id="remove-user-confirm"  class="inline-flex items-center w-[70%] md:w-[50%] justify-center p-3 rounded-3xl bg-[#417690] text-white border border-neutral-150 shadow-sm font-semibold">Leave</button>
      </div>
    </div>
  </div>


  <div id="icon-container" style="display: flex; justify-content: center; gap: 1rem; margin-top: -7px;">
    <!-- Insert our chat icon + dropdown in the user links bar -->
    <div id="chat-icon" onclick="toggleChatDropdown()" class="w-[28px] h-[28px] bg-[royalblue] relative rounded-full items-center flex justify-center">
      <!-- Simple chat icon (SVG) -->
      <div id="message-number" class="text-white absolute top-[-3px] right-[-2px]">0</div>
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4">
        <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 8.511c.884.284 1.5 1.128 1.5 2.097v4.286c0 1.136-.847 2.1-1.98 2.193-.34.027-.68.052-1.02.072v3.091l-3-3c-1.354 0-2.694-.055-4.02-.163a2.115 2.115 0 0 1-.825-.242m9.345-8.334a2.126 2.126 0 0 0-.476-.095 48.64 48.64 0 0 0-8.048 0c-1.131.094-1.976 1.057-1.976 2.192v4.286c0 .837.46 1.58 1.155 1.951m9.345-8.334V6.637c0-1.621-1.152-3.026-2.76-3.235A48.455 48.455 0 0 0 11.25 3c-2.115 0-4.198.137-6.24.402-1.608.209-2.76 1.614-2.76 3.235v6.226c0 1.621 1.152 3.026 2.76 3.235.577.075 1.157.14 1.74.194V21l4.155-4.155" />
      </svg>
    </div>

      <!-- Button to open the modal -->  
    <div id="openModalBtn"  title="create chat rooms" class="cursor-pointer">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-7">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v6m3-3H9m12 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
      </svg>
    </div>
    
  </div>


    <!-- Dropdown panel (initially hidden) -->
    <div id="chatDropdown" class="hidden" style="position: absolute;  height: 92%; overflow-y: hidden; right: 0; margin-top: 8px; width: 480px; background-color: #fff; border: 1px solid #ccc; border-radius: 4px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 50;">
      <div class="h-full">
        <!-- header -->
        <!-- Message area -->        
        <div class="h-full">
          <!-- Left Sidebar (Chats List) -->
          <div class="w-full h-full bg-white border-r border-gray-300">
            <div class="h-full">
              <!-- Search Bar -->
              <div class="p-4 border-b border-gray-300 relative">
                <input 
                  type="text" 
                  placeholder="Search..." 
                  id="messageSearchInput"
                  class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-1 focus:ring-blue-500" 
                />
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4 absolute text-black cursor-pointer right-[23px] top-[23px]">
                  <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
                </svg>
              </div>
          
              <div id="message-search-results" style="display: none;" class="p-4 border rounded-md bg-white max-h-64 overflow-y-auto">
                  <!-- Live search results will be displayed here -->
              </div>


              <!-- Chats List (Scroll) -->
              <div id="chatList" class="h-[86%] flex-1 overflow-y-auto">
                <!-- Single chat item -->
                <div class="cursor-pointer hover:bg-gray-100 p-3 border-b border-gray-200">
                  <div class="font-semibold text-gray-800">Room A</div>
                  <div class="text-sm text-gray-500 truncate">Last message snippet here...</div>
                </div>             
              </div>

              <!-- individual chats -->
              <div id="individual-chatList" class="flex flex-col h-full" style="display: none;">             
                <div class="flex justify-between mr-2">
                <!-- Back Arrow -->
                  <div id="back-arrow" class="cursor-pointer ml-4">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-3 text-black">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18" />
                    </svg>                
                  </div>
                  <div class="flex items-center gap-4">
                  <p id="delete-room" class="cursor-pointer text-red-500">Delete Room</p>                
                  <p id="leave-room" class="cursor-pointer text-red-500">Leave</p>                
                  {% if request.user.username == 'admin' %}
                    <p id="add-user" class="cursor-pointer text-blue-500">Add</p>     
                  {% endif %}
                  
                </div>
              </div>
                <div id="roomTitle" class="mt-4 text-center"></div>

                <div id="search-navigation"></div>
                <!-- Chat List & Input (Inside a container to maintain order) -->
                <div class="flex flex-col flex-1 h-full mt-4">               
                  <!-- Chat Messages -->
                  <div id="individual-chatList-body" class="flex-1 overflow-y-auto h-full" style="position: relative;">
                    
                    <div id="message-body" class="overflow-y-auto"></div>
                </div>
              </div>
              </div>
            </div>

            <div id="suggestion-div" class="bottom-[4rem] absolute h-fit w-[407px] bg-white pl-[8px]" style="display: none;">
              <div id="mentionSuggestions" class="flex flex-col gap-4 bg-white w-[300px] h-fit pt-4" style="text-align: start;"></div>
              <!-- Media Preview -->
              <div id="mediaPreview" class="mb-3"></div>
              <div id="reply-message-div" style="text-align: start; display: none;">
                <div class="w-full flex flex-col gap-4 bg-gray-200 text-gray-600 text-transform-none border-l-2 border-green-200 p-4 rounded-t-md mb-1">
                  <div id="reply-message-cancel" style="align-self: end;">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-3 text-red-500 cursor-pointer">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                    </svg>
                    
                  </div>
                </div>
              </div>
              <div id="typing-div"></div>
            </div>

            <!-- File Upload -->
            <input type="file" id="mediaInput" style="display: none;" accept="image/*">
              

              <!-- Chat Input -->
            <div id="chat-message-parent-div" class="w-full flex justify-center items-center py-2" style="position: absolute; bottom: 0; display: none;">
              <div id="input" class="mt-4 w-full flex gap-2 px-2 relative">
                  <input id="message" type="text" placeholder="type..." 
                        class="bg-transparent outline-none border pl-3 h-[50px] rounded-xl dark:text-white flex-1 text-md font-md" oninput="onInputChange()">
                        <label for="mediaInput" id="mediaInputLabel" class="cursor-pointer absolute bottom-4 right-[6rem]" id="messageMedia">
                          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-5 text-gray-500 cursor-pointer">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75" />
                          </svg>
                        </label>
                  <div id="chat-message-submit" class="text-[#0d2438] dark:text-white cursor-pointer flex flex-col justify-center">
                      <i class="fa fa-paper-plane" aria-hidden="true"></i>
                      <input class="cursor-pointer" type="button" value="Send">
                  </div>
              </div>
            </div>
        </div>  
      </div>
    </div>
    
{% endblock userlinks %}

{% block content %}
    {{ block.super }}
    <!-- The main admin content remains as is. -->
{% endblock content %}

{% block footer %}
{{ block.super }}
<script>
  const csrfToken = "{{ csrf_token }}";  
  const userId = "{{ request.user.username}}";
</script>

<script>
  console.log(csrfToken, userId, "try");

  let header = document.querySelector("#header")
  let userTools = document.querySelector("#user-tools")
  let chatIcon = document.querySelector("#chat-icon")
  let iconContainer = document.querySelector("#icon-container")
  let openModalBtn = document.querySelector("#openModalBtn")
  const chatContainer = document.getElementById("chatList");
  const individualChatList = document.getElementById("individual-chatList");
  const individualChatListBody = document.getElementById("individual-chatList-body");
  const backArrow = document.getElementById("back-arrow");
  const addUserToGroup = document.getElementById("add-user");
  const adminleaveRoomButton = document.getElementById("leave-room");
  const adminDeleteRoomButton = document.getElementById("delete-room");
  const leaveRoomYesOrNoModal = document.getElementById("leave-room-yes-or-no-modal");
  const deleteRoomYesOrNoModal = document.getElementById("delete-room-yes-or-no-modal");
  const removeUserYesOrNoModal = document.getElementById("remove-user-yes-or-no-modal");
  let createChatModal = document.getElementById('create-chatModal')
  let addUserModal = document.getElementById("only-add-user-modal")
  let leaveRoomCloseModalBtn = document.getElementById("leave-room-closeModalBtn")
  let removeUserCloseModalBtn = document.getElementById("remove-user-closeModalBtn")
  let leaveRoomConfirm = document.getElementById("leave-room-confirm")
  let removeUserConfirm = document.getElementById("remove-user-confirm")
  let deleteRoomConfirm = document.getElementById("delete-room-confirm")
  let deleteRoomCloseModalBtn = document.getElementById("delete-room-closeModalBtn")
  let deleteUserConfirm = document.getElementById("delete-user-confirm")
  let replyMessageCancel = document.getElementById("reply-message-cancel")
  backArrow.style.marginTop = '8px'
  const roomDetails = {}
  let replyMessageId;
  let globalSearchId;
  let globalRoomName;
  let adminAddUserRoomTitle;
  let roomMembers;
  let sender 
  let messageCount = 0

  // header.prepend(chatIcon)
  header.prepend(iconContainer)
  function toggleChatDropdown() {
    const dropdown = document.getElementById('chatDropdown');
    dropdown.classList.toggle('hidden');
  }

  // WebSocket setup
  const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
  
  
  const chatSocket = new WebSocket(wsScheme + "://" + window.location.host + "/ws/chat/");
  console.log("chatsocket", chatSocket);
  let currentRoomId = null;
  let currentPage = 1;
  let isLoading = false;

  backArrow.addEventListener("click", function(){
    chatContainer.style.display = 'block'
    individualChatList.style.display = 'none'
    document.getElementById('chat-message-parent-div').style.display = 'none'

  })




  function openChatRoom(roomId, messages, type, roomName, searchId) {
    if(type == "search"){
      document.getElementById("message-search-results").style.display = "none"

      let nextSearchResult = document.createElement("div")
      let previousSearchResult = document.createElement("div")
      nextSearchResult.innerHTML = `<button onclick="highlightSearchResult(currentSearchIndex + 1)">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4 text-black">
                                      <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 15.75 7.5-7.5 7.5 7.5" />
                                    </svg>
                                  </button>`
      previousSearchResult.innerHTML = `<button onclick="highlightSearchResult(currentSearchIndex - 1)">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4 text-black">
                  <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
                </svg>             
              </button> ` 
    const searchNavigation = document.getElementById("search-navigation") 
    searchNavigation.innerHTML = ""   
    searchNavigation.appendChild(nextSearchResult)
    searchNavigation.appendChild(previousSearchResult)                 
    }     
    console.log("opened", "chat");
    const messageNumberElement  = document.querySelector(`#messageNumber-${roomId}`);
    messageNumberElement.innerHTML = ''
    messageNumberElement.style.opacity = 0

      console.log("messageNumberElement",messageNumberElement);
    currentRoomId = roomId;
    currentPage = 1;
    document.getElementById('message-body').innerHTML = ''
    document.getElementById('chat-message-parent-div').style.display = 'block'
    chatContainer.style.display = 'none'
    const roomTitle = document.getElementById("roomTitle")
    roomTitle.innerHTML = roomName
    globalRoomName = roomName
    roomTitle.style.textAlign = 'center'
    individualChatList.style.display = 'block'
    individualChatList.style.color = 'black'

    // Request first batch of messages
    chatSocket.send(JSON.stringify({
        action: "load_messages",
        room_id: roomId,
        page: currentPage
    }));

    if(type === "search"){
      // Store search matches for navigation
      currentSearchIndex = 0;

      // Highlight first match
      setTimeout(() => highlightSearchResult(0, searchId), 1000);
    }
}


//#region   message search

let searchResults = [];  // Store found messages
let currentSearchIndex = -1;  // Track highlighted message index


// let searchArrowButton = document.getElementById("searchBackArrow")
// console.log("cry", searchArrowButton);
// if(searchArrowButton){
  
// }

// chatroom async chat
async function searchMessages() {
    const query = document.getElementById("messageSearchInput").value.trim();
    const individualChatList= document.getElementById("individual-chatList")
    individualChatList.style.display = "none"
    if (!query) {
      document.getElementById("searchResults").innerHTML = "";  
      searchResults = [];
      currentSearchIndex = -1;
      return;
    }

    const csrfToken = getCookie('csrftoken');  

    const response = await fetch(`/profiles/search_messages/?q=${query}`, {
      method: "GET",
      headers: {
        "X-CSRFToken": csrfToken,  
        "Content-Type": "application/json"
      },
      credentials: "include"
    });

    const data = await response.json();
    
    if (data.error) {
      console.error(data.error);
      return;
    }


    console.log("dd", data);

    const resultsDiv = document.getElementById("message-search-results");
    const chatList = document.getElementById("chatList")
    let searchBackArrow = document.createElement("div")
    searchBackArrow.setAttribute("id", 'searchBackArrow')
    searchBackArrow.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4 cursor-pointer text-black">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18" />
                                </svg>
                                `
    searchBackArrow.addEventListener("click", function(){
      console.log("must", searchBackArrow);
      resultsDiv.style.display = "none"
      chatList.style.display = "block";

    })
    // resultsDiv.className = ""
    resultsDiv.innerHTML = "";
    resultsDiv.appendChild(searchBackArrow)

    searchResults = data.results;  
    currentSearchIndex = -1;

    if (data.results.length > 0) {
      chatList.style.display = "none";
        resultsDiv.style.display = "block";
        

        data.results.forEach((room, index) => {
          console.log("search", data.results, index);
          const roomElement = document.createElement("div");
          roomElement.setAttribute('data-search-id', index)
          roomElement.classList.add("p-2", "border-b", "cursor-pointer", "hover:bg-gray-200", "text-black");
          roomElement.innerHTML = `<strong>${room.room_name}</strong> (${room.messages.length} matches)`;
          
          // Click to open the room and highlight the first matching message
          roomElement.addEventListener("click", (event) => {
              const searchId = event.currentTarget.getAttribute("data-search-id");
              console.log("Clicked element's search ID:", searchId);
              globalSearchId = searchId

              const openChatType = "search";
              // Call the openChatRoom function with correct arguments
              openChatRoom(room.room_id, room.content, openChatType, room.room_name, searchId);
          });
          resultsDiv.appendChild(roomElement);
        });
    }else{
      chatList.style.display = "none";
        resultsDiv.style.display = "block";
      let noResult = document.createElement("p")
      noResult.innerHTML = "No result found"
      noResult.style.color = "black"
      resultsDiv.appendChild(noResult)
    }

  }


function highlightSearchResult(index, searchId) {
  console.log("much", searchId);
  
  if (!searchResults || searchResults.length === 0) {
    console.warn("No search results available.");
    return;
    }

  console.log("Valid index:", index);
  console.log("Search Results:", searchResults);
  console.log("Current Room:", searchResults[globalSearchId]);
  let room = searchResults[globalSearchId];  // Get the chat room object
  if (!room || !room.messages || room.messages.length === 0 || index >= room.messages.length || index < 0) {
    console.warn("No messages found for this room.");
    return;
  }

  console.log(index, searchResults.length,searchResults[index]);
 
  console.log("trouble", searchResults[globalSearchId].messages);
  currentSearchIndex = index;
  let messageId = searchResults[globalSearchId].messages[index].id;
  
    // Find the message in chat and highlight it
    const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
    console.log("ache",searchResults);
    if (messageElement) {
      console.log("scroll", messageElement);
      messageElement.scrollIntoView({ behavior: 'smooth', block: 'center' });

      messageElement.style.transition = "background-color 2s ease";
      messageElement.style.backgroundColor = "yellow";

      setTimeout(() => {
          messageElement.style.backgroundColor = "";
      }, 3000);
    }
}


document.addEventListener("keydown", (event) => {
    if (event.key === "ArrowUp") {
        ;
    } else if (event.key === "ArrowDown") {
        highlightSearchResult(currentSearchIndex + 1);
    }
});



document.getElementById("messageSearchInput").addEventListener("input", searchMessages);

//#endregion



function loadChatRoom(roomId) {
    console.log(`Loading chat room: ${roomId}`);

    // Show the chat panel
    document.getElementById("individual-chatList").style.display = "block";

    // Set the room title
    document.getElementById("roomTitle").innerText = `Chat Room ${roomId}`;

    // Clear previous messages
    const chatMessages = document.getElementById("message-body");
    chatMessages.innerHTML = "Loading messages...";

    // Fetch and display messages
    fetch(`/get-messages/?room_id=${roomId}`)
        .then(response => response.json())
        .then(data => {
            chatMessages.innerHTML = "";  // Clear loading text

            data.messages.forEach(msg => {
                const msgDiv = document.createElement("div");
                msgDiv.id = `message-${msg.id}`;  // Set unique ID for highlighting
                msgDiv.classList.add("p-2", "border-b");

                // Message structure
                msgDiv.innerHTML = `
                    <div class="flex gap-4">
                        <p class="text-[#417690] font-bold">${msg.sender}</p>
                        <p class="text-gray-300 text-sm">${msg.timestamp}</p>
                    </div>
                    <p>${msg.content}</p>
                `;

                chatMessages.appendChild(msgDiv);
            });

            console.log("Messages loaded successfully.");
        })
        .catch(error => {
            console.error("Error loading chat messages:", error);
            chatMessages.innerHTML = "Failed to load messages.";
        });
}




// Navigate between search results
function nextSearchResult(roomId) {
    if (searchResults.length > 0) {
        highlightSearchResult(roomId, currentSearchIndex + 1);
    }
}

function previousSearchResult(roomId) {
    if (searchResults.length > 0) {
        highlightSearchResult(roomId, currentSearchIndex - 1);
    }
}

  chatSocket.onopen = () => {
    console.log("WebSocket connection established");
  };


  chatSocket.onmessage = function (event) {
    const data = JSON.parse(event.data);
    console.log("call",data);
    if (data.action === "room_list") {
      updateChatRooms(data);  // Update the chat room UI
    } 
    else if (data.action === "new_room") {
      updateChatRooms(data);  // Update the chat room UI
    } 
    else if (data.action === 'typing') {
      console.log(data);
      let roomId = `chat-room-${data.room}`
      let room = document.getElementById(roomId)
      let typingDiv = document.getElementById('typing-div')
      if(data.typing === true){
        if(data.username !== userId){
          document.getElementById("suggestion-div").style.display = "block"
          typingDiv.innerHTML = `${data.username} is typing` 
          typingDiv.className = "text-green-500 text-sm mb-3 float-left"
          typingDiv.style.cssText = "text-transform: none; font-family: Rubik, sans-serif; font-size: 13px;"      
        }
        room.children[3].innerHTML = `${data.username} is typing`
        room.children[3].className = "text-green-500 text-sm"
       
        room.children[1].style.display = "none"
        room.children[2].style.display = "none"
        room.children[3].style.cssText = "text-transform: none; font-family: Rubik, sans-serif; font-size: 13px;"
      
      }else{
        room.children[1].style.display = "block"
        room.children[2].style.display = "block"
        room.children[3].style.display = "none"
        // document.getElementById("suggestion-div").style.display = "none"
        typingDiv.style.display = "none"
    
      }
    }
    else if (data.action === "message") { 
      console.log("uphreme", data);
      let iconString = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-3 text-gray-500 cursor-pointer">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" /> onClick="openOptions()"
                       </svg>`
      updateChatList(data.room, data.message, data.timestamp, data.sender )
      const formattedText = formatMessage(data.message);
      console.log("wwww", data.message);
      const chatMessages = document.getElementById('message-body');   
      const msgDiv = document.createElement('div');
      const icon = document.createElement('div');
      const messageOptions = document.createElement('div');
      const iconUsernameAndDate = document.createElement('div');
      const replyMessage = document.createElement('p');
      const deleteMessage = document.createElement('p');
      const highlightMessage = document.createElement('p');

      replyMessage.innerHTML = "reply";
      deleteMessage.innerHTML = "delete";
      highlightMessage.innerHTML = "highlight";


       //  Setting their ids and event listeners
      replyMessage.setAttribute("data-id", data.message_id);
      replyMessage.addEventListener("click", (e) => {
        replyMessageId = e.currentTarget.getAttribute("data-id");
        const messageElement = document.querySelector(`[data-message-id="${data.message_id}"]`);
        console.log(data.message_id, "data-id", messageElement);
        const replyMessageDiv = document.getElementById("reply-message-div")
        const messageInput = document.getElementById("message")
        messageInput.focus()
        const gottenReplyMessageUsername= e.target.parentElement.parentElement;
        const replyMessageUsername= document.createElement('p');
        replyMessageUsername.className = "text-green-800"
        const replyMessageContent = document.createElement('p');
        if (messageElement) {
          replyMessageContent.textContent = messageElement.textContent;
          replyMessageContent.className = "text-black"
          console.log("Message text:", messageElement.textContent);
        } else {
          replyMessageContent.textContent = "--";
        }
        
        replyMessageUsername.textContent = gottenReplyMessageUsername.previousSibling.children[0].textContent
        replyMessageDiv.style.display = "block"
        replyMessageDiv.children[0].append(replyMessageUsername)
        replyMessageDiv.children[0].append(replyMessageContent)
        document.getElementById("suggestion-div").style.display = "block";

        
        e.target.parentElement.style.display = "none"
      });
      
      deleteMessage.setAttribute("data-delete-id", data.message_id);
      deleteMessage.addEventListener("click", (e)=>{
        e.target.parentElement.style.display = "none"
        console.log("checkinggg", e.target.parentElement);
        chatSocket.send(JSON.stringify({
            action: "delete",
            message_id: data.message_id
        }));

      })




      messageOptions.className = "message-options flex-col gap-4 bg-white w-fit absolute w-fit p-3 bottom-[-1rem] right-4";
      messageOptions.style.display = "none"
      replyMessage.className = "cursor-pointer text-black hover:bg-gray-100 p-2";
      deleteMessage.className = "cursor-pointer text-black hover:bg-gray-100 p-2";
      highlightMessage.className = "cursor-pointer text-black hover:bg-gray-100 p-2";
      
      
      const messageBody = document.createElement('p');
      messageBody.setAttribute("data-message-id", data.message_id)
      icon.innerHTML = iconString;
      const usernameAndDate = document.createElement('div');
      messageBody.style.textTransform = "none"; 
      messageBody.style.fontFamily = "'Rubik', sans-serif";
      messageBody.style.fontSize = "13px";
      const msgDivDate = document.createElement('p');
      const msgDivUsername = document.createElement('p');
      msgDivDate.textContent = data.timestamp;
      msgDivUsername.textContent = data.username;

      // if a user is replying a message
      if(data.reply_to_content !== "None" && data.reply_to_id !== null){
        const mainMessageContent = document.createElement('p');
        const replyMsgDiv = document.createElement('div');
        mainMessageContent.textContent = formattedText;
        mainMessageContent.style.textAlign = "start"
        replyMsgDiv.innerHTML= `
        <div style="text-align: start;">
          <div class="w-full flex flex-col gap-4 bg-gray-200 text-gray-600 text-transform-none border-l-2 border-green-200 p-4 rounded-t-md mb-1" onClick="findRepliedMessage(${data.reply_to_id})">
          <p class="text-black">${data.sender}</p>
          <p>${data.reply_to_content}</p>
          </div>
        </div> `
        messageBody.appendChild(replyMsgDiv)
        messageBody.appendChild(mainMessageContent)
      }else{
        messageBody.innerHTML = formattedText;
      }
      

      msgDiv.className = "bg-gray-100 p-2 rounded mb-2 relative";
      msgDivUsername.className = "text-[#417690] text-bold";
      msgDivDate.className = "text-gray-300 text-small";
      messageBody.className = "justify-self-start";
      iconUsernameAndDate.className = "flex justify-between";
      usernameAndDate.className = "flex gap-4";

      // appending the messageoptions
      messageOptions.appendChild(replyMessage)
      messageOptions.appendChild(deleteMessage)
      messageOptions.appendChild(highlightMessage)
      icon.appendChild(messageOptions)
      icon.addEventListener("click", (e)=>openOptions(e))
      usernameAndDate.appendChild(msgDivUsername)
      usernameAndDate.appendChild(msgDivDate)
      iconUsernameAndDate.prepend(usernameAndDate)
      iconUsernameAndDate.appendChild(icon)
      msgDiv.prepend(iconUsernameAndDate)
      msgDiv.append(messageBody)
      chatMessages.appendChild(msgDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    else if (data.action === "message_list") {
      console.log("wooo", data);
      const chatMessages = document.getElementById('message-body');
       // Clear old messages
      chatMessages.innerHTML = "";
      chatMessages.style.height = "60%"
      // Reverse messages (oldest first) and add to chat
      data.messages.reverse().forEach(msg => addMessage(msg.username, msg.deleted, msg.message, msg.timestamp, msg.id, msg.username, msg.reply_to, msg.reply_to_num));
      isLoading = false;
      roomMembers = data.members
      // scroll to the bottom
      setTimeout(() => {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }, 100);
    } 
    else if(data.action === "missed_messages"){
      console.log("data.missed_messages", data.missed_messages);
      data.missed_messages.forEach(keyStr => {
        const keys = Object.keys(keyStr);
        console.log("keyStr", keys, keyStr, keyStr[keys[0]])
        const messageNumberElement  = document.querySelector(`#messageNumber-${keys[0]}`);
        console.log(messageNumberElement);
        let messageNumber = messageNumberElement.textContent
        console.log(messageNumber !== "", messageNumber);
        if(messageNumber !== ""){
          messageNumberElement.textContent = Number(messageNumber) + Number(keyStr[keys[0]])
          if(Number(messageNumberElement.textContent)>0){
            messageNumberElement.style.opacity = 1
          }
        }else{
          messageNumberElement.textContent = Number(keyStr[keys[0]])
          if(Number(messageNumberElement.textContent)>0){
            messageNumberElement.style.opacity = 1
            console.log("mmmm");
          }
        }
        
      });
    }
    else if(data.action === "message_deleted"){
      const messageElement = document.querySelector(`p[data-delete-id="${data.message_id}"]`);
      // messageElement.parentElement.style.display = "none"
      console.log(messageElement.parentElement.parentElement.parentElement.parentElement);
      messageElement.parentElement.parentElement.parentElement.parentElement.children[1].innerHTML = "This message has been deleted"
      console.log("juuju",messageElement.parentElement.parentElement.parentElement.parentElement);
      messageElement.parentElement.parentElement.parentElement.parentElement.children[1].className ="text-red-500 justify-self-start"
    }
};



function findRepliedMessage(messageId) {
  const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
  if (messageElement) {
    const container = messageElement.parentElement;
    // Apply a transition so the background color change is smooth.
    container.style.transition = "background-color 2s ease";
    // Set the background to yellow.
    container.style.backgroundColor = "lemon";
    // Scroll the element into view.
    messageElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
    // After 3 seconds, remove the yellow background.
    setTimeout(() => {
      container.style.backgroundColor = "";
    }, 3000);
  }
}



  chatSocket.onerror = function(e) {
    console.error("WebSocket encountered an error:", e);
  };

  chatSocket.onclose = () => {
    console.log("WebSocket connection closed");
  };


  let uploadedMedia = [];  // Stores uploaded media references

  async function uploadMedia(file) {
      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", "your_cloudinary_preset");  // Cloudinary unsigned preset

      try {
          const response = await fetch("https://api.cloudinary.com/v1_1/YOUR_CLOUDINARY_NAME/upload", {
              method: "POST",
              body: formData
          });

          const data = await response.json();
          if (data.secure_url) {
              uploadedMedia.push({ url: data.secure_url, public_id: data.public_id, type: file.type.startsWith('image') ? 'image' : 'video' });
              // displayMediaPreview(data.secure_url, data.public_id);
          }
      } catch (error) {
          console.error("Media upload failed:", error);
      }
  }

  function handleFileSelect(event) {
      const file = event.target.files[0];
      if (file) {
          uploadMedia(file);
      }
  }


//   function displayMediaPreview(url, publicId) {
//     document.getElementById("suggestion-div").style.display = "block";
//     const previewContainer = document.getElementById("mediaPreview");
//     const mediaElement = document.createElement("div");
//     mediaElement.setAttribute("data-media-id", publicId);

//     if(url.endsWith(".mp4") || url.endsWith(".avi") || url.endsWith(".mov")) {
//         mediaElement.innerHTML = `<video src="${url}" width="150" controls></video> <button onclick="removeMedia('${publicId}')">❌</button>`;
//     } else {
//         mediaElement.innerHTML = `<img src="${url}" width="150"> <button onclick="removeMedia('${publicId}')">❌</button>`;
//     }

//     previewContainer.appendChild(mediaElement);
// }


  async function removeMedia(publicId) {
    document.getElementById("mediaPreview").innerHTML = ''
      uploadedMedia = uploadedMedia.filter(media => media.public_id !== publicId);
      document.querySelector(`[data-id="${publicId}"]`).remove();

      // Send delete request to Cloudinary
      await fetch(`/delete_media/${publicId}/`, { method: "DELETE" });
  }

  document.getElementById("mediaInput").addEventListener("change", function(event) {
    const files = event.target.files; // Get selected files
    const previewContainer = document.getElementById("mediaPreview");
    previewContainer.innerHTML = ""; // Clear previous previews

    Array.from(files).forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            displayMediaPreview(e.target.result, `preview-${index}`);
        };
        reader.readAsDataURL(file);
    });
});

function displayMediaPreview(url, publicId) {
    document.getElementById("suggestion-div").style.display = "block";
    const previewContainer = document.getElementById("mediaPreview");
    const mediaElement = document.createElement("div");
    mediaElement.setAttribute("data-media-id", publicId);
    mediaElement.className = "w-fit"
    if (url.startsWith("data:video")) { // Detect video files
        mediaElement.innerHTML = `<button class="cursor-pointer text-red-500 text-md font-lg" onclick="removeMedia('${publicId}')">X</button> <video src="${url}" width="180" controls></video>`;
    } else { // Assume it's an image
        mediaElement.innerHTML = `<button class="cursor-pointer text-red-500 text-md font-lg" onclick="removeMedia('${publicId}')">X</button> <img src="${url}" width="180">`;
    }

    previewContainer.appendChild(mediaElement);
}


// Attach event listener to file input
document.getElementById("mediaInput").addEventListener("change", handleFileSelect);



  // function to send message
  function sendMessage(roomTitle) {
  const input = document.getElementById('message');
  const message = input.value.trim();

  // Assume uploadedMedia is a global variable holding media objects
  // e.g., uploadedMedia = [{ id: 10, url: "https://cdn.example.com/media/10.jpg" }, ...];
  // Prevent sending if there's no text and no media
  if (!message && (!uploadedMedia || uploadedMedia.length === 0)) return;

  // Ensure WebSocket is open before sending a message
  if (chatSocket.readyState === WebSocket.OPEN) {
    // Build the payload
    const payload = {
      action: "send",
      room_id: roomDetails[globalRoomName],
      message: message,
      receiver: roomMembers // assume this is defined (e.g., from room info)
    };

    // If replying, attach the reply message ID
    if (replyMessageId) {
      payload.reply_to_id = replyMessageId;
    }

    // If there are any attached media, include them in the payload
    if (uploadedMedia && uploadedMedia.length > 0) {
      payload.media = uploadedMedia;
    }

    console.log("payload", payload);
    chatSocket.send(JSON.stringify(payload));

    // Hide the suggestion div for mentions (if present)
    const suggestionDiv = document.getElementById("suggestion-div");
    if (suggestionDiv) {
      suggestionDiv.style.display = "none";
    }

    // If there's a reply UI active, remove its extra elements
    const cancelButton = document.getElementById("reply-message-cancel");
    if (cancelButton) {
      // Example logic: remove two sibling elements after the cancel button
      let firstSibling = cancelButton.nextSibling ? cancelButton.nextSibling.nextSibling : null;
      let secondSibling = firstSibling && firstSibling.nextSibling ? firstSibling.nextSibling : null;
      if (firstSibling) firstSibling.remove();
      if (secondSibling) secondSibling.remove();
    }

    // Clear the text input and reset the attached media (if applicable)
    input.value = '';
    document.getElementById("mediaPreview").innerHTML = ""; // Clear media preview
    uploadedMedia = []; // Clear media attachments after sending
    // Optionally, also clear replyMessageId if needed:
    replyMessageId = null;
  } else {
    console.error("WebSocket is not open. Cannot send message.");
  }
}

  // Start typing
function onInputChange() {
  const inputEl = document.getElementById('message');
  const inputValue = inputEl.value;
  chatSocket.send(JSON.stringify({
    action: 'typing',
    room_id: currentRoomId,
    typing: true
  }));

  // Clear any existing timer
  if (window.typingTimer) clearTimeout(window.typingTimer);

  // After 2 seconds of no input, send "typing: false"
  window.typingTimer = setTimeout(() => {
    chatSocket.send(JSON.stringify({
      action: 'typing',
      room_id: currentRoomId,
      typing: false
    }));
  }, 2000);

  // Check for '@' to trigger mention suggestions:
  // Find the last occurrence of '@' in the input value.
  const atIndex = inputValue.lastIndexOf('@');
  if (atIndex !== -1) {
    // Extract the text following the '@'
    const query = inputValue.substring(atIndex + 1);
    
    // Only trigger suggestions if there is some query text (e.g., at least 1 character)
    if (query.length > 0) {
      console.log("query.length");
      // Filter roomMembers array to match the query (case-insensitive)
      const suggestions = roomMembers.filter(member => 
        member.username.toLowerCase().startsWith(query.toLowerCase())
      );

      console.log("problem", suggestions);
      // Show suggestions in the UI
      showMentionSuggestions(suggestions, atIndex);
    } else {
      // Optionally hide suggestions if no query text
      hideMentionSuggestions();
    }
  } else {
    // Hide suggestions if '@' is not found
    hideMentionSuggestions();
  }



}


// Example functions to update your UI with suggestions
function showMentionSuggestions(suggestions, atIndex) {
  const suggestionBox = document.getElementById('mentionSuggestions');
  suggestionBox.style.marginBottom = "10px"
  const suggestionDiv = document.getElementById('suggestion-div');
  suggestionBox.innerHTML = ''; // Clear previous suggestions
  suggestions.forEach(username => {
    console.log("username",username);
    const item = document.createElement('div');
    item.classList.add('suggestion-item', 'text-red-500', 'cursor-pointer');
    item.textContent = username.username;
    console.log("for", item);
    item.addEventListener('click', () => {
      insertMention(username.username, atIndex);
      hideMentionSuggestions();
    });
    suggestionBox.appendChild(item);
  });
  suggestionDiv.style.display = 'flex';
  suggestionBox.style.display = 'flex';
}

function hideMentionSuggestions() {
  const suggestionBox = document.getElementById('mentionSuggestions');
  const suggestionDiv = document.getElementById('suggestion-div');

  suggestionBox.style.display = 'none';
  suggestionDiv.style.display = 'none';
}

function insertMention(username, atIndex) {
  const inputEl = document.getElementById('message');
  const value = inputEl.value;
  // Replace the text after the '@' with the full username
  const beforeAt = value.substring(0, atIndex);
  // You might want to add a trailing space after the mention.
  inputEl.value = `${beforeAt}@${username} `;
  // Optionally, set the caret at the end of the input.
  inputEl.focus();
}


// formatting message to highlight when a user is tagged. using regex to find when a user is tagged
function formatMessage(messageText) {
  const mentionRegex = /@[A-Za-z0-9._-]+(?:@[A-Za-z0-9.-]+\.[A-Za-z]{2,})?/g;
  return messageText.replace(
    mentionRegex,
    `<span class="mention" style="color: purple;">$&</span>`
  );
}



// to updae the chat and move the message div to the top and to update message count
function updateChatList(id, message, timestamp, sender) {  
    messageCount++
    let messageId = `chat-room-${id}`; 
    let roomDiv = `roomDivParent-${id}`; 
    let messageNumber = `messageNumber-${id}`; 
    let messageList = document.getElementById("chatList");
    let individualMessage = document.getElementById(messageId);
    let roomDivParent = document.getElementById(roomDiv);

    if (individualMessage) {
        // Updating the second child (message content)
        let messageText = individualMessage.querySelector(".text-sm");
        if (messageText) messageText.textContent = message;

        // Update timestamp (if there's an element for it)
        let timestampElement = individualMessage.querySelector(".xs"); // Add a timestamp div in HTML
        if (timestampElement) timestampElement.textContent = timestamp;

        if (messageCount > 0 && sender !== userId){
          let numberDiv = document.getElementById(messageNumber)
          console.log(numberDiv);
          numberDiv.style.opacity = 1
          numberDiv.textContent = messageCount
        }

        // Move to top without flickering
        messageList.prepend(roomDivParent);
    } else {
        console.error(`Message with ID "${messageId}" not found.`);
    }
}


document.getElementById("message").addEventListener("keydown", function(event) {
  if (event.key === "Enter") {
    event.preventDefault(); 
    sendMessage(roomTitle); 
  }
});

  document.getElementById("chat-message-submit").addEventListener('click', function(){
    sendMessage(roomTitle)
  })

  function openOptions(e){
    let messageOptions = e.target.nextElementSibling
    console.log("sokoh");
    console.log(e.target);
    console.log(e.target.nextElementSibling);

    if(messageOptions.style.display === "flex"){
      messageOptions.style.display = "none"
    }else if(messageOptions.style.display === "none"){
      messageOptions.style.display = "flex"
    }
  }

  // Function to get all individual message to the UI
  function addMessage(username,deleted, message, timestamp, id, sender, replymsg, replyMsgId) {
    console.log("omo","why");
    let iconString = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-3 text-gray-500 cursor-pointer">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" /> onClick="openOptions()"
                      </svg>`
                      const formattedText = formatMessage(message);
    const chatMessages = document.getElementById('message-body')
    const msgDiv = document.createElement('div');
    const icon = document.createElement('div');
    const messageOptions = document.createElement('div');
    const iconUsernameAndDate = document.createElement('div');
    const usernameAndDate = document.createElement('div');
    const messageBody = document.createElement('p');
    const replyMessage = document.createElement('p');
    const deleteMessage = document.createElement('p');
    const highlightMessage = document.createElement('p');

    if(replymsg !== "None" && replyMsgId !== null){
      console.log("replymsg",replymsg);
      const mainMessageContent = document.createElement('p');
      const replyMsgDiv = document.createElement('div');
      mainMessageContent.textContent = message;
      mainMessageContent.style.textAlign = "start"
      replyMsgDiv.innerHTML= `
      <div style="text-align: start;">
        <div class="w-full flex flex-col gap-4 bg-gray-200 text-gray-600 text-transform-none border-l-2 border-green-200 p-4 rounded-t-md mb-1" onClick="findRepliedMessage(${replyMsgId})">
        <p class="text-black">${sender}</p>
        <p>${replymsg}</p>
        </div>
      </div> `
      messageBody.appendChild(replyMsgDiv)
      messageBody.appendChild(mainMessageContent)
      }else{
        if(deleted){
          messageBody.className = "text-red-500 justify-self-start"
        }else{
          messageBody.className = "justify-self-start";
        }
        messageBody.textContent = formattedText;
      }
      

      //  Setting their ids and event listeners
      replyMessage.setAttribute("data-id", id);
      replyMessage.addEventListener("click", (e) => {
        replyMessageId = e.currentTarget.getAttribute("data-id");
        const messageElement = document.querySelector(`[data-message-id="${id}"]`);
        const replyMessageDiv = document.getElementById("reply-message-div")
        const messageInput = document.getElementById("message")
        messageInput.focus()
        const gottenReplyMessageUsername= e.target.parentElement.parentElement;
        const replyMessageUsername= document.createElement('p');
        replyMessageUsername.className = "text-green-800"
        const replyMessageContent = document.createElement('p');
        if (messageElement) {
          replyMessageContent.textContent = messageElement.textContent;
          replyMessageContent.className = "text-black"
          console.log("Message text:", messageElement.textContent);
        } else {
          replyMessageContent.textContent = "--";
        }
        
        replyMessageUsername.textContent = gottenReplyMessageUsername.previousSibling.children[0].textContent
        replyMessageDiv.style.display = "block"
        replyMessageDiv.children[0].append(replyMessageUsername)
        replyMessageDiv.children[0].append(replyMessageContent)
        document.getElementById("suggestion-div").style.display = "block";

        
        e.target.parentElement.style.display = "none"
      });
      
      deleteMessage.setAttribute("data-delete-id", id);
      deleteMessage.addEventListener("click", (e)=>{
        e.target.parentElement.style.display = "none"
        chatSocket.send(JSON.stringify({
            action: "delete",
            message_id: id
        }));

      })


      messageBody.style.textTransform = "none"; 
      messageBody.style.fontFamily = "'Rubik', sans-serif";
      messageBody.style.fontSize = "13px";
      const msgDivDate = document.createElement('p');
      const msgDivUsername = document.createElement('p');
      replyMessage.innerHTML = "reply";
      deleteMessage.innerHTML = "delete";
      highlightMessage.innerHTML = "highlight";
      messageBody.setAttribute("data-message-id", id)
      icon.innerHTML = iconString;
      msgDivDate.textContent = timestamp;
      msgDivUsername.textContent = username;
      
      messageOptions.className = "message-options flex-col gap-4 bg-white w-fit absolute w-fit p-3 bottom-[-1rem] right-4";
      messageOptions.style.display = "none"
      replyMessage.className = "cursor-pointer text-black hover:bg-gray-100 p-2";
      deleteMessage.className = "cursor-pointer text-black hover:bg-gray-100 p-2";
      highlightMessage.className = "cursor-pointer text-black hover:bg-gray-100 p-2";
      
      msgDiv.className = "p-2 border-b relative";
      msgDivUsername.className = "text-[#417690] text-bold";
      msgDivDate.className = "text-gray-300 text-small";
      
      iconUsernameAndDate.className = "flex justify-between";
      usernameAndDate.className = "flex gap-4";
      messageOptions.appendChild(replyMessage)
      messageOptions.appendChild(deleteMessage)
      messageOptions.appendChild(highlightMessage)
      icon.appendChild(messageOptions)
      icon.addEventListener("click", (e)=>openOptions(e))
      usernameAndDate.appendChild(msgDivUsername)
      usernameAndDate.appendChild(msgDivDate)
      iconUsernameAndDate.prepend(usernameAndDate)
      iconUsernameAndDate.appendChild(icon)
      msgDiv.prepend(iconUsernameAndDate)
      msgDiv.append(messageBody)
      chatMessages.append(msgDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
  }


  replyMessageCancel.addEventListener("click", (e)=>{
    document.getElementById("suggestion-div").style.display= "none"
    const container = e.currentTarget.parentElement;
    console.log("cont", container);
  
    const adminEl = container.querySelector("p.text-green-800");
    const outletEl = container.querySelector("p.text-black");
    adminEl.remove()
    outletEl.remove()
    console.log("adddd", adminEl);
  })



  // Handle Scroll for Pagination
  chatContainer.addEventListener("scroll", () => {
      if (chatContainer.scrollTop === 0 && !isLoading) {
          isLoading = true;
          currentPage += 1;

          chatSocket.send(JSON.stringify({
              action: "load_messages",
              room_id: currentRoomId,
              page: currentPage
          }));
      }
  });

  // Function to update chat room UI
  function updateChatRooms(rooms) {
    const chatList = document.getElementById("chatList");
    if(rooms.action === "room_list"){
      chatList.innerHTML = "";
    }
    console.log("object",rooms);

    if (rooms.rooms.length > 0) {
      if(rooms.action === "new_room"){
        console.log("rooms.rooms",rooms.rooms);
        rooms.rooms.forEach(room => {
        console.log(room);
        console.log(room.id);
            const roomDiv = document.createElement("div");
            roomDiv.setAttribute("id", `chat-room-${room.id}`)
            roomDiv.className = "cursor-pointer hover:bg-gray-100 p-3 border-b border-gray-200";
            roomDiv.innerHTML = `
                <div class="font-semibold text-gray-800">${room.name}</div>
                <div class="text-sm text-gray-500 truncate">You have just been added to this room</div>
            `;
            const searchId = 0
            const messages="empty"
            const openChatType = "message";

            roomDiv.addEventListener("click", function () {openChatRoom(room.id, messages,  openChatType, room.name, searchId);});
            roomDetails[room.name] =  room.id

            chatList.prepend(roomDiv);
        });
      }
      else if(rooms.action === "room_list"){
        rooms.rooms.forEach(room => {
            const roomDiv = document.createElement("div");
            const roomDivParent = document.createElement("div");
            const newMessageNumber = document.createElement("div");
            roomDiv.setAttribute("id", `chat-room-${room.id}`)
            roomDiv.className = "w-[80%]";
            roomDiv.innerHTML = `
                <div class="font-semibold text-gray-800">${room.name}</div>
                <div class="text-sm text-gray-500 truncate">${room.last_message}</div>
                <div class="text-xs text-gray-400">${room.last_message_time}</div>
                <div></div>
            `;
            const searchId = 0
            const messages="empty";
            const openChatType = "message";
            roomDiv.addEventListener("click", function () {openChatRoom(room.id,messages,  openChatType, room.name, searchId);});
            roomDetails[room.name] =  room.id

            newMessageNumber.className = 'w-[20px] h-[20px] bg-red-600 text-white opacity-0 rounded-full flex justify-center items-center'
            // newMessageNumber.style.display = "none"
            newMessageNumber.setAttribute('id', `messageNumber-${room.id}`)
            roomDivParent.className = 'w-full hover:bg-gray-100 p-3 flex items-center justify-around cursor-pointer border-b border-gray-200'
            // roomDivParent.setAttribute('id', `roomDivParent-${room.id}`)
            roomDivParent.appendChild(newMessageNumber);
            roomDivParent.appendChild(roomDiv);
            chatList.appendChild(roomDivParent);
        });
      }
    } else {
        chatList.innerHTML = `<div class="text-gray-500 p-3">No chat rooms available.</div>`;
    }
  }


  // Modal open and close logic
  document.getElementById('openModalBtn').addEventListener('click', () => {
    createChatModal.classList.remove('hidden');
  });
  document.getElementById('closeModalBtn').addEventListener('click', () => {
    createChatModal.classList.add('hidden');
  });

  // Live search for users
  function liveSearchUsers() {
    const query = document.getElementById('userSearch').value;
    const resultsDiv = document.getElementById('searchResults');
    const noUserDiv = document.getElementById('noUserFound');
    
    if (query.length < 2 ) {
      resultsDiv.innerHTML = '';
      noUserDiv.classList.add('hidden');
      return;
    }
    
    fetch(`/profiles/live_admin_user_search/?q=${encodeURIComponent(query)}`)
      .then(response => response.json())
      .then(data => {
        resultsDiv.innerHTML = '';
        if (data.users && data.users.length > 0) {
          noUserDiv.classList.add('hidden');
          data.users.forEach(user => {
            console.log(user);
            const userDiv = document.createElement('div');
            userDiv.className = 'flex items-center justify-between border-b border-gray-200 py-2 text-[#417690]';
            userDiv.innerHTML = `
              <span>${user.email}</span>
              <button onclick="addUserToRoom('${user.id}', '${user.username}')" class="text-blue-500 hover:text-blue-700">Add</button>
            `;
            resultsDiv.appendChild(userDiv);
          });
        } else {
          resultsDiv.innerHTML = '';
          noUserDiv.classList.remove('hidden');
        }
      })
      .catch(error => {
        console.error('Error searching users:', error);
      });
  }


  // Keep track of selected user IDs
  let addedUserIds = [];
 

  // Add user to selected list
  function addUserToRoom(userId, username) {
  console.log("oghene");
    if (addedUserIds.includes(userId)) return;
    addedUserIds.push(userId);
    
    const selectedUsersDiv = document.getElementById('selectedUsers');
    const userEntry = document.createElement('div');
    userEntry.className = 'flex items-center justify-between p-2 bg-gray-100 rounded mt-2 text-[#417690]';
    userEntry.innerHTML = `
      <span>${username}</span>
      <button onclick="removeUserFromRoom('${userId}', this)" class="text-red-500 hover:text-red-700">Remove</button>
    `;
    selectedUsersDiv.appendChild(userEntry);
    
    // Optionally, clear search results and input
    document.getElementById('searchResults').innerHTML = '';
    document.getElementById('userSearch').value = '';
  }

  

  // Remove a user from selected list
  function removeUserFromRoom(userId, btn) {
    addedUserIds = addedUserIds.filter(id => id !== userId);
    btn.parentElement.remove();
  }

  //#region Create Room (POST Request)
  const createRoomBtn = document.getElementById('createRoomBtn');
  
  createRoomBtn.addEventListener('click', () => {
    const roomName = document.getElementById('roomName').value.trim();
    if (!roomName) {
      alert("Please enter a room name.");
      return;
    }

    // Build the POST data
    const payload = {
      roomName: roomName,
      members: addedUserIds
    };
  // If you're using Django's CSRF protection in templates, grab the token:
  const csrfToken = getCookie('csrftoken'); // defining a getCookie below

  fetch('/profiles/chat/create_room/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': csrfToken
    },
    credentials: 'include',  // ensures cookies are sent
    body: JSON.stringify(payload)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      Toastify({
        text: `Room '${data.roomName}' created successfully!`,
        duration: 3000, // Time in milliseconds (3 seconds)
        close: true, // Show close button
        gravity: "top", // `top` or `bottom`
        position: "right", // `left`, `center`, or `right`
        backgroundColor: "linear-gradient(to right, #00b09b, #417690)",
      }).showToast();
      // Clear fields and close modal
      document.getElementById('roomName').value = '';
      addedUserIds = [];
      document.getElementById('selectedUsers').innerHTML = '';
      createChatModal.classList.add('hidden');
      // Optionally redirect to the chat room page
      // window.location.href = `/chat/room/${data.roomName}/`;
    } else {
      Toastify({
          text: `Sorry! an error occured-Error: ${data.error}`,
          duration: 3000, // Time in milliseconds (3 seconds)
          close: true, // Show close button
          gravity: "top", // `top` or `bottom`
          position: "right", // `left`, `center`, or `right`
          backgroundColor: "linear-gradient(to right, #ff4d4d, #ff0000)",
      }).showToast();
      alert();
    }
  })
  .catch(error => {
    console.error('Error creating room:', error);
  });
  });

  

  //#endregion

  

  //#region admin add users
  const adminCloseModalBtn = document.getElementById('admin-closeModalBtn');
  const adminAddUsers = document.getElementById('admin-add-users');


  function adminLiveSearchUsers() {
    const adminQuery = document.getElementById('admin-userSearch').value;
    const adminResultsDiv = document.getElementById('admin-searchResults');
    const adminNoUserDiv = document.getElementById('admin-noUserFound');
    
   
    if (adminQuery.length < 2 ) {
      adminResultsDiv.innerHTML = '';
      adminNoUserDiv.classList.add('hidden');
      return;
    }
    
    fetch(`/profiles/live_admin_user_search/?q=${encodeURIComponent(adminQuery)}`)
      .then(response => response.json())
      .then(data => {
        adminResultsDiv.innerHTML = '';
        if (data.users && data.users.length > 0) {
          adminNoUserDiv.classList.add('hidden');
          data.users.forEach(user => {
            const userDiv = document.createElement('div');
            userDiv.className = 'flex items-center justify-between border-b border-gray-200 py-2 text-[#417690]';
            userDiv.innerHTML = `
              <span>${user.email}</span>
              <button onclick="adminAddUserToRoom('${user.id}', '${user.username}')" class="text-blue-500 hover:text-blue-700">Add</button>
            `;
            adminResultsDiv.appendChild(userDiv);
          });
        } else {
          adminResultsDiv.innerHTML = '';
          adminNoUserDiv.classList.remove('hidden');
        }
      })
      .catch(error => {
        console.error('Error searching users:', error);
      });
  }

  let adminAddedUserIds = [];
  

  function adminAddUserToRoom(userId, username) {
    if (adminAddedUserIds.includes(userId)) return;
    adminAddedUserIds.push(userId);
    
    const selectedUsersDiv = document.getElementById('admin-selectedUsers');
    const userEntry = document.createElement('div');
    userEntry.className = 'flex items-center justify-between p-2 bg-gray-100 rounded mt-2 text-[#417690]';
    userEntry.innerHTML = `
      <span>${username}</span>
      <button onclick="adminRemoveUserFromRoom('${userId}', this)" class="text-red-500 hover:text-red-700">Remove</button>
    `;
    selectedUsersDiv.appendChild(userEntry);
    
    // Optionally, clear search results and input
    document.getElementById('admin-searchResults').innerHTML = '';
    document.getElementById('admin-userSearch').value = '';
  }


  addUserToGroup.addEventListener("click",()=>{
    adminAddUserRoomTitle = document.getElementById("roomTitle").innerHTML;
    addUserModal.style.display= "flex"
  })

  adminAddUsers.addEventListener('click', () => {
    // Build the POST data
    const payload = {
      members: adminAddedUserIds
    };
  // If you're using Django's CSRF protection in templates, grab the token:
  const csrfToken = getCookie('csrftoken'); // defining a getCookie below

  fetch(`/profiles/rooms/${roomDetails[adminAddUserRoomTitle]}/add-members/`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': csrfToken
    },
    credentials: 'include',  // ensures cookies are sent
    body: JSON.stringify(payload)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      adminAddedUserIds = []
      document.getElementById('admin-selectedUsers').innerHTML = '';
      addUserModal.classList.add('hidden');
      Toastify({
        text: "Users added successfully",
        duration: 3000, // Time in milliseconds (3 seconds)
        close: true, // Show close button
        gravity: "top", // `top` or `bottom`
        position: "right", // `left`, `center`, or `right`
        backgroundColor: "linear-gradient(to right, #00b09b, #417690)",
    }).showToast();
    } else {
      Toastify({
        text: "Sorry! an error occured",
        duration: 3000, // Time in milliseconds (3 seconds)
        close: true, // Show close button
        gravity: "top", // `top` or `bottom`
        position: "right", // `left`, `center`, or `right`
        backgroundColor: "linear-gradient(to right, #ff4d4d, #ff0000)",
    }).showToast();
    }
  })
  .catch(error => {
    console.error('Error adding user to room:', error);
  });
  });


  adminCloseModalBtn.addEventListener("click", ()=>{
    addUserModal.style.display = "none"
  })

  adminleaveRoomButton.addEventListener("click", ()=>{
    adminAddUserRoomTitle = document.getElementById("roomTitle").innerHTML;
    leaveRoomYesOrNoModal.style.display = "flex"
  })

  adminDeleteRoomButton.addEventListener("click", ()=>{
    adminAddUserRoomTitle = document.getElementById("roomTitle").innerHTML;
    deleteRoomYesOrNoModal.style.display = "flex"
  })

  leaveRoomCloseModalBtn.addEventListener("click", ()=>{
    leaveRoomYesOrNoModal.style.display = "none"
  })


  leaveRoomConfirm.addEventListener('click', () => {
    
  // If you're using Django's CSRF protection in templates, grab the token:
  const csrfToken = getCookie('csrftoken'); // defining a getCookie below

  fetch(`/profiles/rooms/${roomDetails[adminAddUserRoomTitle]}/leave/`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': csrfToken
    },
    credentials: 'include',  // ensures cookies are sent
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      leaveRoomYesOrNoModal.classList.add('hidden');
      Toastify({
        text: "Users added successfully",
        duration: 3000, // Time in milliseconds (3 seconds)
        close: true, // Show close button
        gravity: "top", // `top` or `bottom`
        position: "right", // `left`, `center`, or `right`
        backgroundColor: "linear-gradient(to right, #00b09b, #417690)",
    }).showToast();
        
  } else {
      Toastify({
        text: "Sorry! an error occured",
        duration: 3000, // Time in milliseconds (3 seconds)
        close: true, // Show close button
        gravity: "top", // `top` or `bottom`
        position: "right", // `left`, `center`, or `right`
        backgroundColor: "linear-gradient(to right, #ff4d4d, #ff0000)",
    }).showToast();
    }
  })
  .catch(error => {
    console.error('Error adding user to room:', error);
  });
  });

  
  deleteRoomCloseModalBtn.addEventListener("click", ()=>{
    deleteRoomYesOrNoModal.style.display = "none"
  })


  deleteRoomConfirm.addEventListener('click', () => {
      
    // If you're using Django's CSRF protection in templates, grab the token:
    const csrfToken = getCookie('csrftoken'); // defining a getCookie below

    fetch(`/profiles/rooms/${roomDetails[adminAddUserRoomTitle]}/delete/`, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
      },
      credentials: 'include',  // ensures cookies are sent
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        deleteRoomYesOrNoModal.classList.add('hidden');
        let roomId = `chat-room-${roomDetails[adminAddUserRoomTitle]}`
        let room = document.getElementById(roomId)
        individualChatList.style.display = "none"  
        chatContainer.style.display = "block"  
        console.log(roomId, roomId);
        room.style.display = "none"
        Toastify({
          text: "Room deleted successfully",
          duration: 3000, // Time in milliseconds (3 seconds)
          close: true, // Show close button
          gravity: "top", // `top` or `bottom`
          position: "right", // `left`, `center`, or `right`
          backgroundColor: "linear-gradient(to right, #00b09b, #417690)",
      }).showToast();
      } else {
        Toastify({
          text: "Sorry! an error occured",
          duration: 3000, // Time in milliseconds (3 seconds)
          close: true, // Show close button
          gravity: "top", // `top` or `bottom`
          position: "right", // `left`, `center`, or `right`
          backgroundColor: "linear-gradient(to right, #ff4d4d, #ff0000)",
      }).showToast();
      }
    })
    .catch(error => {
      console.error('Error adding user to room:', error);
    });
  });

  
  //#endregion


  

  // Helper function to get CSRF token from cookies
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }


</script>
{% endblock footer %}






